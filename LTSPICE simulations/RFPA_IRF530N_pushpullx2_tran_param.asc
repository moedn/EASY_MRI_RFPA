Version 4
SHEET 1 5344 3112
WIRE -544 -848 -544 -912
WIRE 176 -832 176 -864
WIRE -640 -800 -800 -800
WIRE 544 -784 336 -784
WIRE 592 -784 544 -784
WIRE 944 -784 832 -784
WIRE 1056 -784 1024 -784
WIRE 1152 -784 1056 -784
WIRE 1168 -784 1152 -784
WIRE -640 -768 -640 -800
WIRE 832 -768 832 -784
WIRE 1056 -768 1056 -784
WIRE 1168 -768 1168 -784
WIRE -192 -752 -192 -784
WIRE -64 -752 -64 -784
WIRE 336 -752 336 -784
WIRE 544 -752 544 -784
WIRE -800 -736 -800 -800
WIRE -544 -736 -544 -768
WIRE -480 -736 -544 -736
WIRE 176 -720 176 -752
WIRE 176 -720 80 -720
WIRE -544 -704 -544 -736
WIRE -480 -704 -480 -736
WIRE 176 -688 176 -720
WIRE -640 -656 -640 -688
WIRE -64 -656 -64 -672
WIRE 336 -640 336 -672
WIRE -544 -560 -544 -624
WIRE 176 -560 176 -608
WIRE -32 -320 -32 -352
WIRE -144 -208 -208 -208
WIRE -32 -208 -32 -240
WIRE -32 -208 -64 -208
WIRE 0 -208 -32 -208
WIRE -352 -160 -368 -160
WIRE -256 -160 -272 -160
WIRE -208 -160 -208 -208
WIRE -32 -144 -32 -208
WIRE -496 -64 -544 -64
WIRE -400 -64 -400 -96
WIRE -400 -64 -432 -64
WIRE -368 -64 -368 -160
WIRE -368 -64 -400 -64
WIRE -352 -64 -368 -64
WIRE -256 -64 -256 -160
WIRE -256 -64 -272 -64
WIRE -208 -64 -208 -96
WIRE -208 -64 -256 -64
WIRE -112 -64 -208 -64
WIRE -80 -64 -112 -64
WIRE -32 -32 -32 -48
WIRE -32 -16 -32 -32
WIRE -400 0 -400 -64
WIRE -400 96 -400 80
WIRE -400 96 -432 96
WIRE -32 96 -32 64
WIRE -32 208 -32 176
WIRE -144 320 -208 320
WIRE -32 320 -32 288
WIRE -32 320 -64 320
WIRE 0 320 -32 320
WIRE -352 368 -368 368
WIRE -256 368 -272 368
WIRE -208 368 -208 320
WIRE -32 384 -32 320
WIRE -496 464 -528 464
WIRE -400 464 -400 432
WIRE -400 464 -432 464
WIRE -368 464 -368 368
WIRE -368 464 -400 464
WIRE -352 464 -368 464
WIRE -256 464 -256 368
WIRE -256 464 -272 464
WIRE -208 464 -208 432
WIRE -208 464 -256 464
WIRE -112 464 -208 464
WIRE -80 464 -112 464
WIRE -32 496 -32 480
WIRE -32 512 -32 496
WIRE -400 528 -400 464
WIRE -32 624 -32 592
WIRE -400 640 -400 608
WIRE -400 640 -432 640
WIRE -32 752 -32 720
WIRE -144 864 -208 864
WIRE -32 864 -32 832
WIRE -32 864 -64 864
WIRE 0 864 -32 864
WIRE -352 912 -368 912
WIRE -256 912 -272 912
WIRE -208 912 -208 864
WIRE -32 928 -32 864
WIRE -496 1008 -528 1008
WIRE -400 1008 -400 976
WIRE -400 1008 -432 1008
WIRE -368 1008 -368 912
WIRE -368 1008 -400 1008
WIRE -352 1008 -368 1008
WIRE -256 1008 -256 912
WIRE -256 1008 -272 1008
WIRE -208 1008 -208 976
WIRE -208 1008 -256 1008
WIRE -112 1008 -208 1008
WIRE -80 1008 -112 1008
WIRE -32 1040 -32 1024
WIRE -32 1056 -32 1040
WIRE -400 1072 -400 1008
WIRE -400 1168 -400 1152
WIRE -400 1168 -432 1168
WIRE -32 1168 -32 1136
WIRE -32 1264 -32 1232
WIRE -144 1376 -208 1376
WIRE -32 1376 -32 1344
WIRE -32 1376 -64 1376
WIRE 0 1376 -32 1376
WIRE -352 1424 -368 1424
WIRE -256 1424 -272 1424
WIRE -208 1424 -208 1376
WIRE -32 1440 -32 1376
WIRE -496 1520 -528 1520
WIRE -400 1520 -400 1488
WIRE -400 1520 -432 1520
WIRE -368 1520 -368 1424
WIRE -368 1520 -400 1520
WIRE -352 1520 -368 1520
WIRE -256 1520 -256 1424
WIRE -256 1520 -272 1520
WIRE -208 1520 -208 1488
WIRE -208 1520 -256 1520
WIRE -112 1520 -208 1520
WIRE -80 1520 -112 1520
WIRE -32 1552 -32 1536
WIRE -32 1568 -32 1552
WIRE -400 1584 -400 1520
WIRE -32 1680 -32 1648
WIRE -400 1696 -400 1664
WIRE -400 1696 -432 1696
FLAG -32 96 0
FLAG -800 -656 0
FLAG -192 -672 0
FLAG 0 -208 dp
FLAG -112 -64 gp
FLAG -32 -32 sp
FLAG -800 -800 t
FLAG -544 -64 t1p
FLAG -400 -96 t2p
FLAG -32 624 0
FLAG 0 320 dn
FLAG -112 464 gn
FLAG -32 496 sn
FLAG -528 464 t1n
FLAG -400 432 t2n
FLAG -32 -352 VD
FLAG -32 176 VD
FLAG -432 96 VGbias
FLAG -432 640 VGbias
FLAG 544 -672 0
FLAG 336 -640 0
FLAG -640 -656 0
FLAG -480 -704 0
FLAG 80 -720 VD
FLAG -32 1168 0
FLAG 0 864 dp
FLAG -112 1008 gp2
FLAG -32 1040 sp2
FLAG -528 1008 t1p
FLAG -400 976 t2p2
FLAG -32 1680 0
FLAG 0 1376 dn
FLAG -112 1520 gn2
FLAG -32 1552 sn2
FLAG -528 1520 t1n
FLAG -400 1488 t2n2
FLAG -32 720 VD
FLAG -32 1232 VD
FLAG -432 1168 VGbias
FLAG -432 1696 VGbias
FLAG -192 -784 VD
FLAG -544 -912 t1p
FLAG -544 -560 t1n
FLAG -64 -784 VGbias
FLAG 176 -864 dp
FLAG 176 -560 dn
FLAG 592 -784 OUT
FLAG -64 -576 0
FLAG 832 -688 0
FLAG 1056 -688 0
FLAG 1168 -704 0
FLAG 1152 -784 OUT_bpf
SYMBOL nmos -80 -144 R0
SYMATTR InstName M1
SYMATTR Value IRF530n
SYMATTR Prefix X
SYMBOL res -48 -32 R0
SYMATTR InstName R1
SYMATTR Value {Rs}
SYMBOL res -48 -224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value {Rfb}
SYMBOL cap -224 -160 R0
SYMATTR InstName C1
SYMATTR Value {Cfb}
SYMBOL res -416 -16 R0
SYMATTR InstName R3
SYMATTR Value {Rgbias}
SYMBOL res -256 -80 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value {Rg_damp}
SYMBOL ind -368 -144 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L1
SYMATTR Value {Lg_damp}
SYMBOL cap -432 -80 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value {Csource}
SYMBOL voltage -192 -768 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value {VD}
SYMBOL ind -48 -336 R0
SYMATTR InstName L3
SYMATTR Value {Ld}
SYMBOL nmos -80 384 R0
SYMATTR InstName M2
SYMATTR Value IRF530n
SYMATTR Prefix X
SYMBOL res -48 496 R0
SYMATTR InstName R5
SYMATTR Value {Rs}
SYMBOL res -48 304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value {Rfb}
SYMBOL cap -224 368 R0
SYMATTR InstName C4
SYMATTR Value {Cfb}
SYMBOL res -416 512 R0
SYMATTR InstName R7
SYMATTR Value {Rgbias}
SYMBOL res -256 448 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R8
SYMATTR Value {Rg_damp}
SYMBOL ind2 -368 384 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L2
SYMATTR Value {Lg_damp}
SYMATTR Type ind
SYMBOL cap -432 448 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C5
SYMATTR Value {Csource}
SYMBOL ind2 -48 192 R0
SYMATTR InstName L4
SYMATTR Value {Ld}
SYMATTR Type ind
SYMBOL ind2 160 -848 R0
SYMATTR InstName L5
SYMATTR Value {KOUT_LP}
SYMATTR Type ind
SYMATTR SpiceLine Rser=50m
SYMBOL ind2 160 -704 R0
SYMATTR InstName L6
SYMATTR Value {KOUT_LP}
SYMATTR Type ind
SYMATTR SpiceLine Rser=50m
SYMBOL ind2 320 -768 R0
SYMATTR InstName L7
SYMATTR Value {KOUT_LS}
SYMATTR Type ind
SYMBOL res 528 -768 R0
SYMATTR InstName RL
SYMATTR Value {Rload_HV_SE}
SYMBOL ind2 -528 -864 M0
SYMATTR InstName L8
SYMATTR Value {KIN_LS}
SYMATTR Type ind
SYMBOL ind2 -528 -720 M0
SYMATTR InstName L9
SYMATTR Value {KIN_LS}
SYMATTR Type ind
SYMBOL ind2 -624 -784 M0
SYMATTR InstName L10
SYMATTR Value {KIN_LP}
SYMATTR Type ind
SYMBOL nmos -80 928 R0
SYMATTR InstName M3
SYMATTR Value IRF530n
SYMATTR Prefix X
SYMBOL res -48 1040 R0
SYMATTR InstName R9
SYMATTR Value {Rs}
SYMBOL res -48 848 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value {Rfb}
SYMBOL cap -224 912 R0
SYMATTR InstName C3
SYMATTR Value {Cfb}
SYMBOL res -416 1056 R0
SYMATTR InstName R11
SYMATTR Value {Rgbias}
SYMBOL res -256 992 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R12
SYMATTR Value {Rg_damp}
SYMBOL ind -368 928 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L11
SYMATTR Value {Lg_damp}
SYMBOL cap -432 992 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C6
SYMATTR Value {Csource}
SYMBOL ind -48 736 R0
SYMATTR InstName L12
SYMATTR Value {Ld}
SYMBOL nmos -80 1440 R0
SYMATTR InstName M4
SYMATTR Value IRF530n
SYMATTR Prefix X
SYMBOL res -48 1552 R0
SYMATTR InstName R13
SYMATTR Value {Rs}
SYMBOL res -48 1360 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value {Rfb}
SYMBOL cap -224 1424 R0
SYMATTR InstName C7
SYMATTR Value {Cfb}
SYMBOL res -416 1568 R0
SYMATTR InstName R15
SYMATTR Value {Rgbias}
SYMBOL res -256 1504 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R16
SYMATTR Value {Rg_damp}
SYMBOL ind2 -368 1440 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L13
SYMATTR Value {Lg_damp}
SYMATTR Type ind
SYMBOL cap -432 1504 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C8
SYMATTR Value {Csource}
SYMBOL ind2 -48 1248 R0
SYMATTR InstName L14
SYMATTR Value {Ld}
SYMATTR Type ind
SYMBOL voltage -64 -768 R0
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR Value PULSE({VG_init} {VG} {VG_tdelay} {VG_trise} {VG_trise} {VG_tpad*2+tpulse-VG_trise} 10m)
SYMATTR InstName V4
SYMBOL voltage -800 -752 R0
WINDOW 3 -46 82 Right 2
WINDOW 123 -40 28 Right 2
WINDOW 39 -45 52 Right 2
SYMATTR Value SINE(0 {Vin} {f0} {VG_tdelay+VG_tpad} 0 0 {tpulse*f0})
SYMATTR Value2 AC 1
SYMATTR SpiceLine Rser={Rsource_HV_SE}
SYMATTR InstName V2
SYMBOL bv -64 -672 R0
SYMATTR InstName B1
SYMATTR Value V={VG*smallsig()}
SYMBOL bv 832 -784 R0
SYMATTR InstName B2
SYMATTR Value V=V(OUT)
SYMBOL res 1040 -800 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R17
SYMATTR Value 1
SYMBOL ind 1040 -784 R0
SYMATTR InstName L15
SYMATTR Value {bpf_L}
SYMBOL cap 1152 -768 R0
SYMATTR InstName C9
SYMATTR Value {bpf_C}
TEXT 904 -448 Left 2 !;.param f0=2.7e6\n;.param w0={2*3.14159*f0}\n;.param Ld={1/w0**2/Coss}\n \n.param Zscale=0.16\n \n;.param Gm=2\n;.param Rs={(Gm0-Gm)/(Gm0*Gm)}\n.param VG={ID*Rs+Vth}\n;.param Rfb={1000*Zscale}\n;.param Rg=1k\n.param Rg_damp=15\n.param Lg_damp=150n\n;.param Rsource={50*Zscale}\n;.param Rload={50*Zscale}
TEXT 616 -192 Left 2 !.net I(RL) V2
TEXT 576 -160 Left 2 !;.ac dec 1k 100k 10meg
TEXT 976 112 Left 2 !.inc /Models and subcircuits/all_hexfet_subcircuits.inc
TEXT 640 -1688 Left 2 ;trace formulas\nTransconductance of FET Gm0\nIx(M1:D)/V(g,s)\nEffective transconductance Gm\nIx(M1:D)/V(g)
TEXT -1688 -304 Left 2 !;step 1:\n;Choose :\n;Nfets (number of FETs sharing PEP)\n.param Nfets=4\n.param PEPnet_target=200\n.param Rload_net=50\n;PEP (peak output power) \n;VD (drain bias voltage)\n;VDmin (minimum drain voltage of FET, at max amplitude)\n.param PEP_target={PEPnet_target/Nfets}\n.param VD_target=48\n.param VDmin_target=12\n;Voutpk=VD_target-VDmin_target\n.param Voutpk_target={VD_target-VDmin_target}\n;Rload_LV_SE=Voutpk_target^2/(2*PEP_target)\n.param Rload_LV_SE_target={Voutpk_target**2/(2*PEP_target)}\n \n \n;step 1.1 \n; can use the exact target Rload_LV_SE_target\n.param Rload_LV_SE={Rload_LV_SE_target}\n.param VD=VD_target\n.param PEP=PEP_target\n.param Voutpk=Voutpk_target\n.param VDmin=VDmin_target\n \n; or override it with something realizable with the transformers\n; if I override Rload, then PEP will be allowed  to change\n;.param Rload_LV_SE=12.5\n;.param PEP={PEP_target*Rload_LV_SE/Rload_LV_SE_target}\n; and recalculate other things\n;.param Voutpk={sqrt(Rload_LV_SE*2*PEP_target)}\n;.param VD=VD_target\n;.param VDmin={VD-Voutpk}\n \n;For impedance match on output, set Rout_LV_SE=Rload_LV_SE\n.param Rout_LV_SE={Rload_LV_SE}\n \n;step 2:\n; choose IDmin (minimum drain current of FET, at max amplitude)\n.param IDmin=0.5\n; ID=IDmin+Voutpk/Rload_LV_SE\n.param ID={IDmin+Voutpk/Rload_LV_SE}\n; given Gm0, the Gm of the FET at ID\n; and choose Gm, between 0.1Gm0 and 0.5Gm0\n;.param Gm0=2\n.param Gm=2\n; source resistor Rs=(Gm0-Gm)/(Gm0*Gm)\n.param Rs={(Gm0-Gm)/(Gm0*Gm)}\n \n;step 3:\n; choose gate bias resistor Rgbias\n.param Rgbias=100\n; choose source resistance\n.param Rsource_LV_SE=12.5\n; in parallel they make Rsource2\n.param Rsource2_LV_SE = {(Rgbias*Rsource_LV_SE)/(Rgbias+Rsource_LV_SE)}\n; calculate feedback resistance Rfb\n.param Rfb=Rout_LV_SE*(1+Gm*Rsource2_LV_SE)-Rsource2_LV_SE\n \n;step 4:\n; choose f0/w0\n.param f0=2.7e6\n.param w0={2*3.14159*f0}\n; calculate blocking caps\n; choose cutoff fc=f0/fcratio\n.param fcratio_fb=10\n.param fcratio_source=5\n;.param fc={f0/fcratio}\n;.param wc={w0/fcratio}\n.param Cfb={fcratio_fb/(w0*Rfb)}\n.param Csource={fcratio_source/(w0*Rsource_LV_SE)}\n; calculate drain bias inductor to cancel Coss\n;.param Coss=100p\n.param Ld={1/w0**2/Coss}\n \n; calculate Rin, looking from Rsource\n.param Rin_LV_SE={Rgbias*(Rfb+Rload_LV_SE)/(Rgbias*(Gm*Rload_LV_SE+1)+Rfb+Rload_LV_SE)}
TEXT 928 264 Left 2 !.meas PEP PARAM {PEP}\n.meas VD PARAM {VD}\n.meas VDmin PARAM {VDmin}\n.meas Rload_LV_SE_target PARAM {Rload_LV_SE_target}\n.meas Rload_LV_SE PARAM {Rload_LV_SE}\n.meas IDmin PARAM {IDmin}\n.meas ID PARAM {ID}\n.meas Gm0 PARAM {Gm0}\n.meas Gm PARAM {Gm}\n.meas Rs PARAM {Rs}\n.meas Rgbias PARAM {Rgbias}\n.meas Rsource PARAM {Rsource_LV_SE}\n.meas Rfb PARAM {Rfb}\n.meas Cfb PARAM {Cfb}\n.meas Csource PARAM {Csource}\n.meas Rin_LV_SE PARAM {Rin_LV_SE}\n.meas VG PARAM {VG}\n.meas Coss PARAM {Coss}\n.meas Ld PARAM {Ld}\n.meas KIN_LP PARAM {KIN_LP}\n.meas KIN_LS PARAM {KIN_LS}\n.meas KOUT_LP PARAM {KOUT_LP}\n.meas KOUT_LS PARAM {KOUT_LS}\n.meas Rload_HV_SE PARAM {Rload_HV_SE}\n.meas Rsource_HV_SE PARAM {Rsource_HV_SE}
TEXT 176 -1176 Left 2 !KOUT L5 L6 L7 1\n;inductance per each unit winding\n.param KOUT_AL=10u\n;winding on each side of low voltage center-tapped side\n.param KOUT_N_LV=1\n.param KOUT_N_HV=4\n.param KOUT_LP={KOUT_N_LV**2*KOUT_AL}\n.param KOUT_LS={KOUT_N_HV**2*KOUT_AL}\n.param Rload_HV_SE={2*Rload_LV_SE*KOUT_LS/(4*KOUT_LP)/(Nfets/2)}
TEXT -744 -1192 Left 2 !KIN L10 L8 L9 1\n;inductance per each unit winding\n.param KIN_AL=10u\n;winding on each side of low voltage center-tapped side\n.param KIN_N_LV=1\n.param KIN_N_HV=4\n.param KIN_LP={KIN_N_HV**2*KOUT_AL}\n.param KIN_LS={KIN_N_LV**2*KOUT_AL}\n.param Rsource_HV_SE={2*Rsource_LV_SE*KIN_LP/(4*KIN_LS)/(Nfets/2)}
TEXT 568 -96 Left 2 !.tran 0 {VG_tdelay+VG_tpad+50u+10/f0} {VG_tdelay+VG_tpad+50u} 1u
TEXT -224 -496 Left 2 !.param tpulse=1m\n.param VG_tpad=50u\n.param VG_trise=10u\n.param VG_tdelay=50u\n.param VG_init = 0
TEXT -880 -584 Left 2 !.param Vin_scale=1\n.param Vin={40*Vin_scale}
TEXT -2608 -224 Left 2 !; FOR MEASURING COMPRESSION\n.step oct param Vin_scale 0.015 0.5 1\n.meas TRAN Vout_RMS_fund RMS V(OUT_bpf)\n.meas TRAN Av_fund RMS {V(OUT_bpf)/(Vin/1.414)}\n.meas TRAN Pout_fund PARAM {(Vout_RMS_fund**2/Rload_HV_SE)}\n.meas TRAN G_dB PARAM 20*log10(Av_fund)\n.meas TRAN Pbias AVG -V(VD)*I(V1)\n.meas TRAN Efficiency PARAM Pout_fund/Pbias
TEXT 904 -624 Left 2 !.param bpf_Q=10\n.param bpf_C={bpf_Q/(w0)}\n.param bpf_L={1/(bpf_Q*w0)}
TEXT 1536 -1008 Left 2 !;.include /FET_bias_conditions/fetprops_irf510_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf520_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf520n_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf530_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf530n_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf540n_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf630_ID_1p0.inc\n;.include /FET_bias_conditions/fetprops_irf630n_ID_1p0.inc\n \n;.include /FET_bias_conditions/fetprops_irf510_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf520_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf520n_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf530_ID_3p1.inc\n.include /FET_bias_conditions/fetprops_irf530n_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf540n_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf630_ID_3p1.inc\n;.include /FET_bias_conditions/fetprops_irf630n_ID_3p1.inc
