* C:\Users\Joshua Rhodes\Dropbox\Mike Twieg Publications\ISMRM\2022 diy scanner\RFPA board\LTspice\RFPA_General_pushpullx2_tran_param_Tlines.asc
R1 s1p 0 {Rs}
R2 N003 N004 {Rfb}
C1 N004 g1p {Cfb}
R3 b1p VGbias {Rgbias}
R4 g1p b1p {Rg_damp}
L1 b1p g1p {Lg_damp}
C2 b1p N008 {Csource}
V1 VD 0 {VD}
L3 VD N003 {Ld}
L5 dp VD {KOUT_LP} Rser=50m
L6 VD dn {KOUT_LP} Rser=50m
L7 OUT 0 {KOUT_LS}
RL OUT 0 {Rload_HV_SE}
L8 in1p 0 {KIN_LS}
L9 0 in1n {KIN_LS}
L10 t 0 {KIN_LP}
V4 VGbias N001 PULSE({VG_init} {VG} {VG_tdelay} {VG_trise} {VG_trise} {VG_tpad*2+tpulse-VG_trise} 10m)
V2 t 0 SINE(0 {Vin} {f0} {VG_tdelay+VG_tpad} 0 0 {tpulse*f0}) AC 1 Rser={Rsource_HV_SE}
B1 N001 0 V={VG*smallsig()}
B2 N002 0 V=V(OUT)
R17 OUT_bpf N002 1
L15 OUT_bpf 0 {bpf_L}
C9 OUT_bpf 0 {bpf_C}
XM1 N007 N009 N010 irf530n
L17 N010 s1p {Lpar_S} Rpar={EPR_S}
L18 N003 N007 {Lpar_D} Rpar={EPR_D}
L19 g1p N009 {Lpar_G} Rpar={EPR_G}
R18 s2p 0 {Rs}
R19 N011 N012 {Rfb}
C10 N012 g2p {Cfb}
R20 b2p VGbias {Rgbias}
R21 g2p b2p {Rg_damp}
L16 b2p g2p {Lg_damp}
C11 b2p N014 {Csource}
L20 VD N011 {Ld}
XM2 N013 N015 N016 irf530n
L21 N016 s2p {Lpar_S} Rpar={EPR_S}
L22 N011 N013 {Lpar_D} Rpar={EPR_D}
L23 g2p N015 {Lpar_G} Rpar={EPR_G}
R5 s1n 0 {Rs}
R6 N017 N018 {Rfb}
C3 N018 g1n {Cfb}
R7 b1n VGbias {Rgbias}
R8 g1n b1n {Rg_damp}
L2 b1n g1n {Lg_damp}
C4 b1n N022 {Csource}
L4 VD N017 {Ld}
XM3 N021 N023 N024 irf530n
L11 N024 s1n {Lpar_S} Rpar={EPR_S}
L12 N017 N021 {Lpar_D} Rpar={EPR_D}
L13 g1n N023 {Lpar_G} Rpar={EPR_G}
R9 s2n 0 {Rs}
R10 N025 N026 {Rfb}
C5 N026 g2n {Cfb}
R11 b2n VGbias {Rgbias}
R12 g2n b2n {Rg_damp}
L14 b2n g2n {Lg_damp}
C6 b2n N028 {Csource}
L24 VD N025 {Ld}
XM4 N027 N029 N030 irf530n
L25 N030 s2n {Lpar_S} Rpar={EPR_S}
L26 N025 N027 {Lpar_D} Rpar={EPR_D}
L27 g2n N029 {Lpar_G} Rpar={EPR_G}
R13 N006 0 {atten_Rshunt_in}
R14 N008 0 {atten_Rshunt_out}
R15 N008 N006 {atten_Rser}
R16 N005 0 {atten_Rshunt_in}
R22 N014 0 {atten_Rshunt_out}
R23 N014 N005 {atten_Rser}
R24 N020 0 {atten_Rshunt_in}
R25 N022 0 {atten_Rshunt_out}
R26 N022 N020 {atten_Rser}
R27 N019 0 {atten_Rshunt_in}
R28 N028 0 {atten_Rshunt_out}
R29 N028 N019 {atten_Rser}
T1 N005 0 N006 0 Td={1.5/Vp_in} Z0={Z0_gates}
T2 in1p 0 N005 0 Td={1.7/Vp_in} Z0={Z0_gates}
T3 N019 0 N020 0 Td={1.5/Vp_in} Z0={Z0_gates}
T4 in1n 0 N019 0 Td={1.5/Vp_in} Z0={Z0_gates}
T5 N011 0 N003 0 Td={1.5/Vp_in} Z0={Z0_drains}
T6 N003 0 dp 0 Td={1.0/Vp_in} Z0={Z0_drains}
T7 N025 0 N017 0 Td={1.5/Vp_in} Z0={Z0_drains}
T8 N017 0 dn 0 Td={1.0/Vp_in} Z0={Z0_drains}
R30 dn N017 {Tline_Rshunt}
R31 N019 in1n {Tline_Rshunt}
R32 N017 N025 {Tline_Rshunt}
R33 dp N003 {Tline_Rshunt}
R34 N003 N011 {Tline_Rshunt}
R35 N006 N005 {Tline_Rshunt}
R36 N005 in1p {Tline_Rshunt}
R37 N020 N019 {Tline_Rshunt}
.param Rg_damp=15
.param Lg_damp=150n
.net I(RL) V2
.ac dec 1k 100k 500meg
;.tran 0 {VG_tdelay+VG_tpad+50u+10/f0} {VG_tdelay+VG_tpad+50u} 1u
; FOR MEASURING COMPRESSION
;.step oct param Vin_scale 0.0625 1 4
.meas TRAN Vout_RMS_fund RMS V(OUT_bpf)
.meas TRAN Av_fund RMS {V(OUT_bpf)/(Vin/1.414)}
.meas TRAN Pout_fund PARAM {(Vout_RMS_fund**2/Rload_HV_SE)}
.meas TRAN G_dB PARAM 20*log10(Av_fund)
.meas TRAN Pbias AVG -V(VD)*I(V1)
.meas TRAN Efficiency PARAM Pout_fund/Pbias
; SPICE models/subcircuits to include
.lib irf630_sihf630_PS_formatted.spi
.lib irf530n.sub
.lib irf540n.sub
.lib irf630N.sub
* ; IRF530\n.param VD=48\n.param Gm0=4\n.param ID=1\n.param Vth=4.5\n.param Coss=320p
* ; IRF510, Ids=1\n.param VD=48\n.param Gm0=1.8\n.param ID=1\n.param Vth=5\n.param Coss=100p
* ; IRF510, Ids=2\n.param VD=48\n.param Gm0=2.5\n.param ID=2\n.param Vth=5.3\n.param Coss=100p
* ; IRF510, Ids=4\n.param VD=48\n.param Gm0=2.6\n.param ID=4\n.param Vth=6.05\n.param Coss=100p
* ; IRF510, Ids=5\n.param VD=48\n.param Gm0=2.75\n.param ID=5\n.param Vth=6.35\n.param Coss=100p
* ; IRF530, Ids=2.5\n;.param VD=48\n.param Gm0=4.4\n;.param ID=2.5\n.param Vth=4.75\n.param Coss=320p
* ; IRF530, Ids=4\n.param VD=48\n.param Gm0=5.4\n.param ID=4\n.param Vth=5.1\n.param Coss=320p
* ; IRF530N, Ids=4\n.param VD=48\n.param Gm0=16\n.param ID=4\n.param Vth=4.0\n.param Coss=130p
* ; IRF530N, Ids=5\n.param VD=48\n.param Gm0=16\n.param ID=5\n.param Vth=4.2\n.param Coss=130p
; IRF530N, Ids=2.5
;.param VD=48
.param Gm0=16
;.param ID=2.5
.param Vth=4.00
.param Coss=130p
* ; IRF540N, Ids=2.5\n.param VD=48\n.param Gm0=15\n.param ID=2.5\n.param Vth=3.8\n.param Coss=250p
* ; IRF630, Ids=2.5\n.param VD=48\n.param Gm0=3.7\n.param ID=2.5\n.param Vth=5.28\n.param Coss=240p
* trace formulas\nTransconductance of FET Gm0\nIx(M1:D)/V(g,s)\nEffective transconductance Gm\nIx(M1:D)/V(g)\nStability factor\n(1-abs(S11(v2))**2-abs(S22(v2))**2+abs(S11(v2)*S22(v2)-S12(v2)*S21(v2))**2)/(2*abs(S21(v2)*S12(v2)))\njust delta\nS11(v2)*S22(v2)-S12(v2)*S21(v2)
* ; IRF630N, Ids=2.5\n;.param VD=48\n.param Gm0=10\n;.param ID=2.5\n.param Vth=4\n.param Coss=240p
;step 1:
;Choose :
;Nfets (number of FETs sharing PEP)
.param Nfets=4
.param PEPnet_target=200
.param Rload_net=50
;PEP (peak output power)
;VD (drain bias voltage)
;VDmin (minimum drain voltage of FET, at max amplitude)
.param PEP_target={PEPnet_target/Nfets}
.param VD_target=48
.param VDmin_target=12
;Voutpk=VD_target-VDmin_target
.param Voutpk_target={VD_target-VDmin_target}
;Rload_LV_SE=Voutpk_target^2/(2*PEP_target)
.param Rload_LV_SE_target={Voutpk_target**2/(2*PEP_target)}
;step 1.1
; can use the exact target Rload_LV_SE_target
.param Rload_LV_SE={Rload_LV_SE_target}
.param VD=VD_target
.param PEP=PEP_target
.param Voutpk=Voutpk_target
.param VDmin=VDmin_target
; or override it with something realizable with the transformers
; if I override Rload, then PEP will be allowed  to change
;.param Rload_LV_SE=12.5
;.param PEP={PEP_target*Rload_LV_SE/Rload_LV_SE_target}
; and recalculate other things
;.param Voutpk={sqrt(Rload_LV_SE*2*PEP_target)}
;.param VD=VD_target
;.param VDmin={VD-Voutpk}
;For impedance match on output, set Rout_LV_SE=Rload_LV_SE
.param Rout_LV_SE={Rload_LV_SE}
;step 2:
; choose IDmin (minimum drain current of FET, at max amplitude)
.param IDmin=0.5
; ID=IDmin+Voutpk/Rload_LV_SE
.param ID={IDmin+Voutpk/Rload_LV_SE}
; given Gm0, the Gm of the FET at ID
; and choose Gm, between 0.1Gm0 and 0.5Gm0
;.param Gm0=2
.param Gm=2
; source resistor Rs=(Gm0-Gm)/(Gm0*Gm)
.param Rs={(Gm0-Gm)/(Gm0*Gm)}
; calculate gate bias voltage
; Vth depends on MOSFET model
.param VG={ID*Rs+Vth}
;step 3:
; choose gate bias resistor Rgbias
.param Rgbias=100
; choose source resistance
.param Rsource_LV_SE=12.5
; in parallel they make Rsource2
.param Rsource2_LV_SE = {(Rgbias*Rsource_LV_SE)/(Rgbias+Rsource_LV_SE)}
; calculate feedback resistance Rfb
.param Rfb=Rout_LV_SE*(1+Gm*Rsource2_LV_SE)-Rsource2_LV_SE
;step 4:
; choose f0/w0
.param f0=2.7e6
.param w0={2*3.14159*f0}
; calculate blocking caps
; choose cutoff fc=f0/fcratio
.param fcratio_fb=10
.param fcratio_source=5
;.param fc={f0/fcratio}
;.param wc={w0/fcratio}
.param Cfb={fcratio_fb/(w0*Rfb)}
.param Csource={fcratio_source/(w0*Rsource_LV_SE)}
; calculate drain bias inductor to cancel Coss
;.param Coss=100p
.param Ld={1/w0**2/Coss}
; calculate Rin, looking from Rsource
.param Rin_LV_SE={Rgbias*(Rfb+Rload_LV_SE)/(Rgbias*(Gm*Rload_LV_SE+1)+Rfb+Rload_LV_SE)}
.meas PEP PARAM {PEP}
.meas VD PARAM {VD}
.meas VDmin PARAM {VDmin}
.meas Rload_LV_SE_target PARAM {Rload_LV_SE_target}
.meas Rload_LV_SE PARAM {Rload_LV_SE}
.meas IDmin PARAM {IDmin}
.meas ID PARAM {ID}
.meas Gm0 PARAM {Gm0}
.meas Gm PARAM {Gm}
.meas Rs PARAM {Rs}
.meas Rgbias PARAM {Rgbias}
.meas Rsource_LV_SE PARAM {Rsource_LV_SE}
.meas Rfb PARAM {Rfb}
.meas Cfb PARAM {Cfb}
.meas Csource PARAM {Csource}
.meas Rin_LV_SE PARAM {Rin_LV_SE}
.meas VG PARAM {VG}
.meas Coss PARAM {Coss}
.meas Ld PARAM {Ld}
.meas KIN_LP PARAM {KIN_LP}
.meas KIN_LS PARAM {KIN_LS}
.meas KOUT_LP PARAM {KOUT_LP}
.meas KOUT_LS PARAM {KOUT_LS}
.meas Rload_HV_SE PARAM {Rload_HV_SE}
.meas Rsource_HV_SE PARAM {Rsource_HV_SE}
KOUT L5 L6 L7 1
;inductance per each unit winding
.param KOUT_AL=10u
;winding on each side of low voltage center-tapped side
.param KOUT_N_LV=1
.param KOUT_N_HV=4
.param KOUT_LP={KOUT_N_LV**2*KOUT_AL}
.param KOUT_LS={KOUT_N_HV**2*KOUT_AL}
.param Rload_HV_SE={2*Rload_LV_SE*KOUT_LS/(4*KOUT_LP)/(Nfets/2)}
KIN L10 L8 L9 1
;inductance per each unit winding
.param KIN_AL=10u
;winding on each side of low voltage center-tapped side
.param KIN_N_LV=1
.param KIN_N_HV=4
.param KIN_LP={KIN_N_HV**2*KOUT_AL}
.param KIN_LS={KIN_N_LV**2*KOUT_AL}
.param Rsource_HV_SE={2*Rsource_LV_SE*KIN_LP/(4*KIN_LS)/(Nfets/2)}
.param tpulse=1m
.param VG_tpad=50u
.param VG_trise=10u
.param VG_tdelay=50u
.param VG_init = 0
.param Vin_scale=1
.param Vin={20*Vin_scale}
.param bpf_Q=10
.param bpf_C={bpf_Q/(w0)}
.param bpf_L={1/(bpf_Q*w0)}
.param Lpar_S=7.5n
.param EPR_S=100
.param Lpar_D=4.5n
.param EPR_D=100
.param Lpar_G=7.5n
.param EPR_G=100
;.param atten_Rin={Rsource_LV_SE}
;.param atten_Rout={Rin_LV_SE}
.param atten_Rin=12.5
.param atten_Rout=12.5
.param atten_dB=3
;atten_Rin
;atten_Rout
;atten_Vout
.param atten_Vout={sqrt(atten_Rout/atten_Rin/(10**(atten_dB*0.1)))}
;.param atten_Rshunt_in={((atten_Rout*atten_Rin)-(atten_Rin**2)*(atten_Vout**2))}
.param atten_Rshunt_in={((atten_Rout*atten_Rin)-(atten_Rin**2)*(atten_Vout**2))/(atten_Rout+(atten_Rin*atten_Vout**2)-(2*atten_Rin*atten_Vout))}
.param atten_Rshunt_out={atten_Vout/(1/atten_Rin-atten_Vout/atten_Rout-1/atten_Rshunt_in)}
.param atten_Rser={((1-atten_Vout)*(atten_Rin*atten_Rshunt_in))/(atten_Rshunt_in-atten_Rin)}
.meas atten_Vout PARAM {atten_Vout}
.meas atten_Rshunt_in PARAM {atten_Rshunt_in}
.meas atten_Rshunt_out PARAM {atten_Rshunt_out}
.meas atten_Rser PARAM {atten_Rser}
* BPF for measuring fundamental \ncomponent of RFPA output
* Input/output transformer baluns
; input/gate traces are 24mil
; output/drain traces are 32mil
; substrate is 62mils
.param Z0_gates = 109
.param Z0_drains = 98.25
; effective permittivity
.param e_eff=2.8
; propagation velocity, in m/s
.param Vp_m={3e8/sqrt(e_eff)}
; propagation velocity, in inches/s
.param Vp_in={Vp_m*100/2.54}
; for shunting out Tlines
.param Tline_Rshunt=1meg
.step param Tline_Rshunt LIST 1m 1meg
.backanno
.end
